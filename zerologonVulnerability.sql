
INSERT INTO `Agents` (`Name`,`LocID`,`ClientID`,`ComputerID`,`DriveID`,`CheckAction`,`AlertAction`,`AlertMessage`,`ContactID`,`interval`,`Where`,`What`,`DataOut`,`Comparor`,`DataIn`,`LastScan`,`LastFailed`,`FailCount`,`IDField`,`AlertStyle`,`Changed`,`Last_Date`,`Last_User`,`ReportCategory`,`TicketCategory`,`Flags`,`GUID`,`AgentDefaultGUID`,`WarningCount`,`DeviceId`) Values('CVE-2020-1472 Zerologon Vulnerability Monitor','0','0','3292','0','6','3','%NAME% on %COMPUTERNAME%~~~%NAME% %STATUS% on %COMPUTERNAME% at %LOCATIONNAME%\\%CLIENTNAME%.\r\nOS: %os%\r\nResult: %RESULT%\r\n.\r\n|monitorid=%agentid%!!!%NAME% on %COMPUTERNAME%~~~%NAME% %STATUS% on %COMPUTERNAME% at %LOCATIONNAME%\\%CLIENTNAME%.\r\nOS: %os%\r\nResult: %RESULT%\r\n\r\nIt is extremely important for this server to be patched or removed from service immediately.\r\nAdditional Information: \r\nhttps://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1472\r\nhttps://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1472\r\n.\r\n|monitorid=%agentid%','0','7200','127.0.0.1','7','\"%windir%\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\" -noprofile -command \"& {$tpDebug=0\;$MVer=1.0\;$ProgressPreference=\'SilentlyContinue\'\;IF (-not ($psversiontable.psversion -gt 1.9)) {\'Error:POSH 2.0+ Required\'\;exit}\;$tpvalue=\'4566116|4565349|4565351|4566782|4570333|4571694|457170[23]|4571719|457172[39]|4571736|4571748|4577015|45770[34]8|457705[13]|457706[269]|4577071|4574727\'\;$Errs={}.Invoke()\;$Outs={}.Invoke()\;$KBLIST=@{}\;$KBResult=@()\;$i=0\;$r=0\;$h=0\;$k=0\;try {$WUSess=New-Object -ComObject \'Microsoft.Update.Session\'\;$WUSearch=$WUSess.CreateUpdateSearcher()\;$FormatEnumerationLimit=-1\;$WUHist=$WUSearch.GetTotalHistoryCount()\;if ($WUHist -gt 0) {$Outs.Add(\'Loading Windows Update History\')\;$WUSearch.QueryHistory(0, $WUHist)|Select-Object Title,Date,Operation,Resultcode|Where-Object {$_.Operation -match \'[12]\' -and $_.Resultcode -match \'[123]\' -and $_.Date -gt \'1/1/1980\'}|Sort-Object Date,Title|ForEach-Object {$Title=$_.Title\;$KBID=$($Title|Select-String \'KB\\d{6,7}\' -AllMatches|ForEach-Object{$_.matches}|ForEach-Object {$_.Value})\;IF($KBID) {switch($_.operation){1{$Outs.Add(\'Adding \'+$KBID+\': \'+$Title)\;$i+=1\;$KBLIST.Set_Item($KBID,$Title)}\;2{$Outs.Add(\'Removing \'+$KBID)\;$r+=1\;$KBLIST.Remove($KBID)}}}}} else {$Errs.Add(\'Windows Update History Unavailable\')}} catch {$Errs.Add(\'Error retrieving Windows Update History\')}\;try {$Outs.Add(\'Loading Get-Hotfix Reported Updates\')\;Get-Hotfix|ForEach-Object {$KBID=$_.HotfixID\;IF($KBID -match \'KB\\d{6,7}\') {$h+=1\;if (-not $KBLIST.ContainsKey($KBID)) {$Outs.Add(\'Adding \'+$KBID)\;$k+=1\;$KBLIST.Set_Item($KBID,$KBID)} else {$Outs.Add($KBID+\' already found\')}}}} catch {$Errs.Add(\'Error retrieving Get-Hotfix results\')}\;$Outs.Add(\'Filtering Updates\')\;$KBLIST.GetEnumerator()|sort-object|Where-Object {($_.Value -match \'KB(\'+$tpvalue+\')\' -and $tpvalue.Length -gt 25)}|ForEach-Object {$Outs.Add(\'Successfully Matched \'+$_.Name)\;$KBResult+=$_.Name}\;IF (-not $($tpvalue.Length -gt 25)) {$Errs.Add(\'Error - Template Property kbid_ms17_010 not found\')}\;IF ($tpDebug -eq 1) {\'Windows Update - \'+$i+\' installed, \'+$r+\' removed\'\;\'Get-Hotfix - \'+$k+\'/\'+$h+\' hotfixes added.\'\;\'Matched Updates: \'+$KBResult.Count\;$Outs.GetEnumerator()}\;IF ($KBResult) {\'Secured - Detected Updates \'+$($KBResult)|Out-String} else {\'Vulnerable - No Matching KB Found.\'\;$Errs.GetEnumerator()}}\"','16','5|Secured|11|(Secured%7CVulnerable)|5|Vulnerable','2020/10/22 16:03:48','1979/01/01 01:01:01','0','','1','0','2020/10/22 16:03:48','root@localhost','22','119','0','','','0','0');
