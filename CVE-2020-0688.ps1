<#This script is outputting either !ERROR:, !WARNING:, or !SUCCESS:. These are to use in a state based remote monitor
in Automate.
-!FAILED: will only output if the machine is eligible to receive the CVE-2020-0688 patch and something in the script 
actually failed and needs attention
-!WARNING: will only output if the machine is not eligible for the CVE-2020-0688 patch
-!SUCCESS: will only output if the pathc has been verified to be installed
#>

Try{
    ## Determine if this is a 32 or 64 bit OS
    $osBit = (Get-WmiObject win32_operatingsystem).OSArchitecture
    ## Get the OS name, then set the proper link depending on OS and architecture
    $osVers = (Get-WmiObject win32_operatingsystem).Caption
	$exchangeVers = Get-Command ExSetup | ForEach {$_.FileVersioninfo}
   If ($osVers -like '*Server 2008 R2*') {
       Write-Warning '!Warning: Exchange 2007 is vulnerable to CVE-2020-0688'
    } ElseIf ($osVers -like '*Server 2012*' -and $osVers -notlike '*R2*') {
        if($exchangeVers.productionversion -ge 14.03.0496.000){
        Write-Warning '!Success: Server 2010 SP3 is patched and protected against CVE-2020-0688'
    }} ElseIf ($osVers -like '*Server 2012 R2*') {
        if($exchangeVers.productionversion -ge 15.00.1497.002){
		Write-Warning '!Success: Server 2013 is patched and protected against CVE-2020-0688'
    }} ElseIf ($osVers -like '*Server 2016*'){
        if ($exchangeVers.productversion -ge 15.01.2044.004){
		Write-Warning '!Success: Server 2016 is patched and protected against CVE-2020-0688'
    }} ElseIf ($osVers -like '*Server 2019*') {
        if ($exchangeVers.productversion -ge 15.02.0659.004){
		Write-Warning '!Success: Server 2019 is patched and protected against CVE-2020-0688'
	
    }} Else {
        ## If we got here it means the OS on the machine this ran on wasn't on the supported list from MS. See the link in the output below.
        Write-Warning "!WARNING: The exchange version in use is vulnerable to CVE-2020-0688"
        Break
    }
} Catch {
    ## Bounce here if there was an issue getting the OS / architecture / KB link
    Write-Warning '!ERROR: There was a problem detecting the OS version'
    Break
}
