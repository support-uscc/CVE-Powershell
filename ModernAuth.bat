@echo off
CALL :REGMULTI ADD "HKMULTI\Software\Microsoft\Office\15.0\Common\Identity" /v "EnableADAL" /t "REG_DWORD" /d "1" /f
CALL :REGMULTI ADD "HKMULTI\Software\Microsoft\Office\15.0\Common\Identity" /v "Version" /t "REG_DWORD" /d "1" /f
CALL :REGMULTI ADD "HKMULTI\Software\Microsoft\Exchange" /v "AlwaysUseMSOAuthForAutoDiscover" /t "REG_DWORD" /d "1" /f
REM Script REG-MULTI.BAT by Darren White @ Ray Morgan - 20171010
REM Run with "/HELP" to show instructions.

:REGMULTI
setlocal ENABLEDELAYEDEXPANSION
IF "%~1"=="" GOTO :DefaultAction
ECHO %~2 | FINDSTR /B /I /C:"HKMULTI\\" > NUL || GOTO :ShowUsage

SET OPERATION=
IF /I "%~1"=="ADD" SET OPERATION=ADD
IF /I "%~1"=="DELETE" SET OPERATION=DELETE
IF /I "%~1"=="QUERY" SET OPERATION=QUERY
IF "%OPERATION%"=="" GOTO :ShowUsage

SET "REGCOMMAND=%*"

IF 1==1 (
SETLOCAL
rem Parsing all availables profiles
rem Get SID
for /f "tokens=7 delims=\\" %%i in ('reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList" /s /v ProfileImagePath ^| findstr /v ProfileImagePath') do (
 set $GetUsers.SID=%%i
 rem Get SID physical path associated
 for /f "tokens=3*" %%i in ('reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList\!$GetUsers.SID!" /v ProfileImagePath ^| findstr /i /v REG.EXE') do (
   rem Get the user name from this path
   if "%%j" NEQ "" (call set $GetUsers.Profil=%%i%%j) else (call set $GetUsers.Profil=%%i)
   set $GetUsers.UserName=!$GetUsers.Profil!& for /l %%i in (0,1,255) do (for /f "tokens=2,* delims=\" %%i in ("!$GetUsers.UserName!") do (if "%%j" NEQ "" (set $GetUsers.UserName=%%i\%%j) else (set $GetUsers.UserName=%%i)))
 )
 CALL :REGOPERATION "!$GetUsers.SID!" "!$GetUsers.Profil!"
)
ENDLOCAL
REM Add to .DEFAULT profile
CALL :REGOPERATION ".DEFAULT"
)

exit /b
:REGOPERATION
SETLOCAL
REM Pass the SID and Profile path
SET "$RegOperation.SID=%~1"
SET "$RegOperation.PATH=%~2"

REM Check if hive already loaded
SET REGLOAD=0
REG QUERY "HKU\!$RegOperation.SID!" /ve > NUL 2>&1 || (
 REM TO SKIP USERS THAT ARE NOT LOGGED IN, UNCOMMENT THE NEXT LINE
 REM ENDLOCAL & exit /b
 REM Load Hive if needed.
 IF NOT EXIST "!$RegOperation.PATH!\ntuser.dat" ENDLOCAL & EXIT /B
 SET REGLOAD=1
 REG LOAD "HKU\!$RegOperation.SID!" "!$RegOperation.PATH!\ntuser.dat" > NUL
)
REM Run REG Command - Query to verify key path is valid
REG QUERY "HKU\!$RegOperation.SID!" /ve > NUL 2>&1 && (
REM ECHO REG %REGCOMMAND:HKMULTI\=HKU\!$RegOperation.SID!\%
REG %REGCOMMAND:HKMULTI\=HKU\!$RegOperation.SID!\% 2>NUL
)
REM Unload if loaded manually
IF %REGLOAD%==1 REG UNLOAD "HKU\!$RegOperation.SID!" > NUL

ENDLOCAL
exit /b

:DefaultAction
REM Use this section to embed registry actions if the script was run without parameters
REM For each action, use: " CALL "%~f0"  "
REM For example, to add an entry under "Software\Microsoft\Windows\CurrentVersion\Run" named "StartCMDWindow" run:
REM CALL :REGMULTI ADD "HKMULTI\Software\Application\RegKey" /v "Value Name" /t "REG_SZ" /d "Data for value" /f
REM CALL :REGMULTI ADD "HKMULTI\Software\Application\RegKey" /v "Value Name2" /t "REG_SZ" /d "Data for value2" /f
REM CALL :REGMULTI DELETE "HKMULTI\Software\Application\RegKey\Subkey" /v "Value Three" /f

REM If calls are included, comment out the following line to prevent the instructions from printing.
GOTO :ShowUsage

exit /b
:ShowUsage
ECHO Usage: %~n0 ^ ^
ECHO Multi user interface to "reg.exe". Executes the requested command in each user profile hive.
ECHO REG ADD, DELETE, and QUERY are the only supported commands. Use "HKMULTI" for the registry path.
ECHO Example: %~n0 ADD "HKMULTI\Software\Microsoft\Windows\CurrentVersion\Run" /v "StartCMDWindow" /t REG_SZ /d "cmd.exe" /f
exit /b 1
